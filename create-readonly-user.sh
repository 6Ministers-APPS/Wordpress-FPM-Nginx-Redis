#!/bin/bash
set -e

echo "ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Read-Only –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."

# --- –®–ê–ì 1. –ü–†–û–í–ï–†–ö–ê –ü–ê–†–û–õ–Ø ---
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—É—Å—Ç–∞—è –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è READONLY_PASSWORD
if [ -z "$READONLY_PASSWORD" ]; then
    echo "‚ÑπÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è READONLY_DB_PASSWORD –Ω–µ –∑–∞–¥–∞–Ω–∞ –≤ Coolify."
    echo "‚è≠Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'monitor_user' —Å–æ–∑–¥–∞–Ω –ù–ï –ë–£–î–ï–¢. –ü—Ä–æ–ø—É—Å–∫–∞—é."
    exit 0
fi

# --- –®–ê–ì 2. –°–û–ó–î–ê–ù–ò–ï (–ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –µ—Å—Ç—å) ---
echo "üîë –ü–∞—Ä–æ–ª—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ü—Ä–∏—Å—Ç—É–ø–∞—é –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º IF NOT EXISTS ‚Äî —ç—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å.
mysql -u root -p"${MARIADB_ROOT_PASSWORD}" <<-EOSQL
    -- –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
    CREATE USER IF NOT EXISTS 'monitor_user'@'%' IDENTIFIED BY '${READONLY_PASSWORD}';

    -- –í—ã–¥–∞–µ–º –ø—Ä–∞–≤–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ —é–∑–µ—Ä —É–∂–µ –±—ã–ª, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç –ø—Ä–∞–≤–∞, —á—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
    GRANT SELECT ON ${MARIADB_DATABASE}.* TO 'monitor_user'@'%';

    -- –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    FLUSH PRIVILEGES;
EOSQL

echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'monitor_user' —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."