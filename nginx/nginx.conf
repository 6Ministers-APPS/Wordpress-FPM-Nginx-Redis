# =========================================================================
# 1. –ù–ê–°–¢–†–û–ô–ö–ò –ö–≠–®–ê FASTCGI
# =========================================================================

fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;

# –ö–ª—é—á –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è. 
# Nginx Helper –æ–∂–∏–¥–∞–µ—Ç: $scheme$request_method$host$request_uri
fastcgi_cache_key "$scheme$request_method$host$request_uri";

fastcgi_cache_use_stale error timeout invalid_header http_500 updating;
fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

# =========================================================================
# 2. –õ–û–ì–ò–ö–ê –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô (MAPS)
# =========================================================================

# POST –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –∫—ç—à–∏—Ä—É–µ–º
map $request_method $skip_cache {
    default 0;
    POST    1;
}

# üëá –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
# –ú—ã –ù–ï –æ—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à –¥–ª—è –≤—Å–µ–≥–æ –ø–æ–¥—Ä—è–¥ (UTM –º–µ—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å—Å—è!)
# –û—Ç–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü WP.
map $query_string $skip_cache_query {
    default 0;
    # –û—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
    "~*(s=|p=|search=|preview=|addon=|action=|logout|feed|sitemap)"   1; 
}

# –ö—É–∫–∏ (Auth, Cart)
map $http_cookie $skip_cache_cookie {
    default 0;
    "~*comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in" 1;
    "~*woocommerce_items_in_cart|edd_items_in_cart|woocommerce_cart_hash" 1;
}

# =========================================================================
# 3. –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê
# =========================================================================

server {
  listen 80 default_server;
  http2 on;
  server_name _;
  
  # –õ–ò–ú–ò–¢–´
  client_max_body_size 256M;

  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
  open_file_cache max=5000 inactive=20s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;
    
  # üëá –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–∞–π–º–∞—É—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∫ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º –¥–ª—è Highload
  fastcgi_read_timeout 60s;
  fastcgi_send_timeout 60s;
  fastcgi_connect_timeout 10s;
  
  # –°–µ—Ç—å
  keepalive_timeout 45;
  reset_timedout_connection on;
  client_body_timeout 35;
  client_header_timeout 12;
  send_timeout 30;
  
  root /var/www/html;
  index index.php index.html;
  server_tokens off;
  
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  # -----------------------------------------------------------------------
  # –ë–õ–û–ö CompressX (WebP / AVIF)
  # -----------------------------------------------------------------------
  set $ext_avif ".avif";
  if ($http_accept !~* "image/avif") { set $ext_avif ""; }

  set $ext_webp ".webp";
  if ($http_accept !~* "image/webp") { set $ext_webp ""; }

  location ~ /wp-content/(?<path>.+)\.(?<ext>jpe?g|png|gif|webp)$ {
    add_header Vary Accept;
    add_header Cache-Control "private";
    expires 365d;
    try_files
      /wp-content/compressx-nextgen/$path.$ext$ext_avif
      /wp-content/compressx-nextgen/$path.$ext$ext_webp
      /wp-content/$path.$ext
      $uri =404;
  }
  # -----------------------------------------------------------------------

  # –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨
  location ~* /\.(?!well-known\/) { deny all; }
  location ~\.(ini|log|conf)$ { deny all; }
  location ~* /(?:uploads|files)/.*\.php$ { deny all; }
  location = /xmlrpc.php { deny all; }

  # –ò–≥–Ω–æ—Ä –ª–æ–≥–æ–≤ –¥–ª—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  location = /robots.txt { try_files $uri $uri/ /index.php?$args; access_log off; log_not_found off; }
  location = /favicon.ico { access_log off; log_not_found off; }

  # -----------------------------------------------------------------------
  # –°–ë–û–†–ö–ê –£–°–õ–û–í–ò–ô –ü–†–û–ü–£–°–ö–ê –ö–≠–®–ê
  # -----------------------------------------------------------------------
  set $do_skip_cache 0;

  # 1. –ú–µ—Ç–æ–¥ (POST)
  if ($skip_cache) { set $do_skip_cache 1; }
  
  # 2. üëá –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ "–ª—é–±–æ–≥–æ" Query String.
  # –¢–µ–ø–µ—Ä—å –º—ã –¥–æ–≤–µ—Ä—è–µ–º MAP (—Å–º. –≤—ã—à–µ), –∫–æ—Ç–æ—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ s=, preview= –∏ —Ç.–¥.
  if ($skip_cache_query) { set $do_skip_cache 1; }

  # 3. –ö—É–∫–∏
  if ($skip_cache_cookie) { set $do_skip_cache 1; }

  # 4. –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏
  if ($request_uri ~* "/wp-admin/|/wp-json/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
      set $do_skip_cache 1;
  }
  # 5. –ú–∞–≥–∞–∑–∏–Ω
  if ($request_uri ~* "/cart/|/checkout/|/my-account/|/wc-api|/edd-api|/wp-login") {
      set $do_skip_cache 1;
  }

  # -----------------------------------------------------------------------
  # –û–°–ù–û–í–ù–û–ô –ë–õ–û–ö
  # -----------------------------------------------------------------------
  location / {
      try_files $uri $uri/ /index.php?$args;
  }
 
  location ~ \.php$ {
    try_files $uri =404;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    
    fastcgi_pass wordpress:9000;
    fastcgi_index index.php;
    include fastcgi_params;
    
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param HTTP_HOST $host;
    fastcgi_param REQUEST_SCHEME $scheme;
    fastcgi_param HTTPS on; 

    # –ö–≠–®
    fastcgi_cache WORDPRESS;
    fastcgi_cache_valid 200 60m;
    fastcgi_cache_bypass $do_skip_cache;
    fastcgi_no_cache $do_skip_cache;

    add_header X-FastCGI-Cache $upstream_cache_status;
    
    # –ë—É—Ñ–µ—Ä—ã
    fastcgi_buffer_size 128k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_buffers 4 256k;
    
    # –ü—Ä–æ–±—Ä–æ—Å IP
    fastcgi_param HTTP_X_REAL_IP $remote_addr;
    fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
    fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
    
    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header Permissions-Policy "accelerometer=(), camera=(self), geolocation=(), gyroscope=(), magnetometer=(), microphone=(self), payment=*, usb=(), fullscreen=*, autoplay=*, display-capture=()";
  }

  location ~ /\.ht { deny all; }

  # –°–¢–ê–¢–ò–ö–ê
  # üëá –î–æ–±–∞–≤–ª–µ–Ω woff2
  location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|woff2|mp4|ttf|ttc|rss|atom|jpg|jpeg|gif|png|ico|webp|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf|css|js|html|xml|avif)$ {
      access_log off; 
      expires max; 
      add_header Cache-Control "public, no-transform";     
  }
    
  # –°–ñ–ê–¢–ò–ï
  gzip on;
  gzip_comp_level 6;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;
  
  gzip_types
    application/atom+xml
    application/geo+json
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rdf+xml
    application/rss+xml
    application/vnd.ms-fontobject
    application/wasm
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/eot
    font/otf
    font/ttf
    image/bmp
    image/svg+xml
    text/cache-manifest
    text/calendar
    text/css
    text/javascript
    text/markdown
    text/plain
    text/xml
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy;

    # Brotli
    brotli on;
    brotli_comp_level 6;
    brotli_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
}