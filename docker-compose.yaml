# documentation: https://wordpress.org 
# slogan: Wordpress is open source software you can use to create a beautiful website, blog, or app.
# tags: cms, blog, content, management, mariadb
# logo: svgs/wordpress.svg

services:
  wordpress:
    build: .
    volumes:
      - ./wordpress-files:/var/www/html
      - ./php/wp-php.ini:/usr/local/etc/php/conf.d/wp-php.ini
      - ./nginx-cache:/var/run/nginx-cache
      - ./init-script.sh:/usr/local/bin/init-script.sh
      - ./php-fpm-tuning.conf:/usr/local/etc/php-fpm.d/zz-tuning.conf
    environment:
      - SERVICE_FQDN_WORDPRESS
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_USER=$SERVICE_USER_WORDPRESS
      - WORDPRESS_DB_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_DEBUG=false
      # Ð•ÑÐ»Ð¸ Ð² Coolify Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ð°, Ð±ÑƒÐ´ÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ ":-"
      - WP_DEBUG=${WP_DEBUG:-false}
      - WP_DEBUG_LOG=${WP_DEBUG_LOG:-false}
      - WP_DEBUG_DISPLAY=${WP_DEBUG_DISPLAY:-false}
    depends_on:
      - mariadb
    command: sh -c "chmod +x /usr/local/bin/init-script.sh && /usr/local/bin/init-script.sh & docker-entrypoint.sh php-fpm"  
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1"]
      interval: 2s
      timeout: 10s
      retries: 10

# --- ÐÐžÐ’Ð«Ð™ Ð¡Ð•Ð Ð’Ð˜Ð¡: WP-CRON (Sidecar) ---
  wp-cron:
    build: .
    container_name: wp_cron_worker
    restart: unless-stopped
    volumes:
      # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ‚Ðµ Ð¶Ðµ Ñ„Ð°Ð¹Ð»Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ WP-CLI Ð²Ð¸Ð´ÐµÐ» ÐºÐ¾Ð´ ÑÐ°Ð¹Ñ‚Ð° Ð¸ wp-config.php
      - ./wordpress-files:/var/www/html
      - ./php/wp-php.ini:/usr/local/etc/php/conf.d/wp-php.ini
    environment:
      # ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ðº Ð‘Ð”, Ñ‚Ð°Ðº ÐºÐ°Ðº WP-CLI Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ PHP Ð¸ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ðº Ð±Ð°Ð·Ðµ
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_USER=$SERVICE_USER_WORDPRESS
      - WORDPRESS_DB_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - WORDPRESS_DB_NAME=wordpress
    depends_on:
      - mariadb
      - wordpress
    entrypoint: >
      sh -c "
      echo 'â³ Ð–Ð´Ñƒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°...' &&
      sleep 20 &&
      echo 'ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº WP-Cron Worker...' &&
      while true; do
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÑ€Ð¾Ð½ Ñ‡ÐµÑ€ÐµÐ· CLI. --allow-root Ð½ÑƒÐ¶ÐµÐ½, Ñ‚Ð°Ðº ÐºÐ°Ðº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÑÑ‚Ð°Ñ€Ñ‚ÑƒÐµÑ‚ Ð¾Ñ‚ Ñ€ÑƒÑ‚Ð°.
        # > /dev/null Ð³Ð°ÑÐ¸Ñ‚ Ð²Ñ‹Ð²Ð¾Ð´, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð·Ð°ÑÐ¾Ñ€ÑÑ‚ÑŒ Ð»Ð¾Ð³Ð¸, ÐµÑÐ»Ð¸ Ð·Ð°Ð´Ð°Ñ‡ Ð½ÐµÑ‚.
        wp cron event run --due-now --allow-root --path=/var/www/html > /dev/null 2>&1
        sleep 60
      done"
  # ---------------------------------------

  nginx:
    image: fholzer/nginx-brotli:latest
    volumes:
      - ./nginx:/etc/nginx/conf.d
      - ./wordpress-files:/var/www/html
      - ./logs/nginx:/var/log/nginx
      - ./nginx-cache:/var/run/nginx-cache
    depends_on:
      - wordpress
      
  mariadb:
    image: mariadb:11
    volumes:
      - ./mariadb-data:/var/lib/mysql
      - ./my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./create-readonly-user.sh:/docker-entrypoint-initdb.d/init-readonly.sh
    ports:
      - "127.0.0.1:3306:3306"    
    environment:
      - MYSQL_ROOT_PASSWORD=$SERVICE_PASSWORD_ROOT
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=$SERVICE_USER_WORDPRESS
      - MYSQL_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - READONLY_PASSWORD=${READONLY_DB_PASSWORD}     
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 20s
      retries: 10
 
  redis:
    image: redis:latest
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - ./redis-data:/data
    command: ["redis-server", "--maxmemory 512mb", "--maxmemory-policy allkeys-lru", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5      

  phpmyadmin:
    image: lscr.io/linuxserver/phpmyadmin:latest
    depends_on:
      - mariadb
    ports:
      - "8070:80"      
    environment:
      - PMA_HOST=mariadb
      - PMA_PASSWORD=$SERVICE_PASSWORD_ROOT
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
      - PMA_ARBITRARY=1
      - PMA_ABSOLUTE_URI=$SERVICE_FQDN_WORDPRESS
    volumes:
      - ./phpmyadmin-config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80"]
      interval: 2s
      timeout: 10s
      retries: 15    