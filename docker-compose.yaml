# documentation: https://wordpress.org 
# slogan: Wordpress is open source software you can use to create a beautiful website, blog, or app.
# tags: cms, blog, content, management, mariadb
# logo: svgs/wordpress.svg

services:
  wordpress:
    build: .
    volumes:
      - ./wordpress-files:/var/www/html
      - ./php/wp-php.ini:/usr/local/etc/php/conf.d/wp-php.ini
      - ./init-script.sh:/usr/local/bin/init-script.sh
      - ./php-fpm-tuning.conf:/usr/local/etc/php-fpm.d/zz-tuning.conf
      - fastcgi_cache:/var/run/nginx-cache
    environment:
      - SERVICE_FQDN_WORDPRESS
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_USER=$SERVICE_USER_WORDPRESS
      - WORDPRESS_DB_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_DEBUG=false
      # –ï—Å–ª–∏ –≤ Coolify –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∑–∞–¥–∞–Ω–∞, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ ":-"
      - WP_DEBUG=${WP_DEBUG:-false}
      - WP_DEBUG_LOG=${WP_DEBUG_LOG:-false}
      - WP_DEBUG_DISPLAY=${WP_DEBUG_DISPLAY:-false}
    depends_on:
      - mariadb
    command: sh -c "chmod +x /usr/local/bin/init-script.sh && /usr/local/bin/init-script.sh & docker-entrypoint.sh php-fpm"
    healthcheck:
      test: [ "CMD-SHELL", "test -f /var/www/html/wp-config.php" ]
      interval: 2s
      timeout: 10s
      retries: 10

  # --- –ù–û–í–´–ô –°–ï–†–í–ò–°: WP-CRON (Sidecar) ---
  wp-cron:
    build: .
    restart: unless-stopped
    volumes:
      # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç–µ –∂–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã WP-CLI –≤–∏–¥–µ–ª –∫–æ–¥ —Å–∞–π—Ç–∞ –∏ wp-config.php
      - ./wordpress-files:/var/www/html
      - ./php/wp-php.ini:/usr/local/etc/php/conf.d/wp-php.ini
    environment:
      # –ü–µ—Ä–µ–¥–∞–µ–º –¥–æ—Å—Ç—É–ø—ã –∫ –ë–î, —Ç–∞–∫ –∫–∞–∫ WP-CLI –∑–∞–ø—É—Å–∫–∞–µ—Ç PHP –∏ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –±–∞–∑–µ
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_USER=$SERVICE_USER_WORDPRESS
      - WORDPRESS_DB_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - WORDPRESS_DB_NAME=wordpress
    depends_on:
      - mariadb
      - wordpress
    entrypoint: >
      sh -c " echo '‚è≥ –ñ–¥—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –∏ –∫–æ–Ω—Ñ–∏–≥–∞...' && sleep 20 && echo 'üöÄ –ó–∞–ø—É—Å–∫ WP-Cron Worker...' && while true; do
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫—Ä–æ–Ω —á–µ—Ä–µ–∑ CLI. --allow-root –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞—Ä—Ç—É–µ—Ç –æ—Ç —Ä—É—Ç–∞.
        # > /dev/null –≥–∞—Å–∏—Ç –≤—ã–≤–æ–¥, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –ª–æ–≥–∏, –µ—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç.
        wp cron event run --due-now --allow-root --path=/var/www/html > /dev/null 2>&1
        sleep 60
      done"
  # ---------------------------------------

  nginx:
    image: fholzer/nginx-brotli:latest
    entrypoint: /bin/sh -c "umask 0000; nginx -g 'daemon off;'"
    volumes:
      - ./nginx:/etc/nginx/conf.d
      - ./wordpress-files:/var/www/html
      - ./logs/nginx:/var/log/nginx
      - fastcgi_cache:/var/run/nginx-cache
    depends_on:
      - wordpress

  mariadb:
    image: mariadb:11
    volumes:
      - ./mariadb-data:/var/lib/mysql
      - ./my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./create-readonly-user.sh:/docker-entrypoint-initdb.d/init-readonly.sh
    ports:
      - "127.0.0.1:3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=$SERVICE_PASSWORD_ROOT
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=$SERVICE_USER_WORDPRESS
      - MYSQL_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - READONLY_PASSWORD=${READONLY_DB_PASSWORD}
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 5s
      timeout: 20s
      retries: 10

  redis:
    image: redis:latest
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - ./redis-data:/data
    command: [ "redis-server", "--maxmemory", "512mb", "--maxmemory-policy", "allkeys-lru", "--save", "", "--appendonly", "no" ]
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 5

  phpmyadmin:
    image: lscr.io/linuxserver/phpmyadmin:latest
    depends_on:
      - mariadb
    ports:
      - "8070:80"
    environment:
      - PMA_HOST=mariadb
      - PMA_PASSWORD=$SERVICE_PASSWORD_ROOT
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
      - PMA_ARBITRARY=1
      - PMA_ABSOLUTE_URI=$SERVICE_FQDN_WORDPRESS
    volumes:
      - ./phpmyadmin-config:/config
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://127.0.0.1:80" ]
      interval: 2s
      timeout: 10s
      retries: 15

# üëá –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±—Ä–∞–Ω—ã –æ—Ç—Å—Ç—É–ø—ã, –±–ª–æ–∫ –ø—Ä–∏–∂–∞—Ç –≤–ª–µ–≤–æ
volumes:
  # –ù–∞—à RAM-–¥–∏—Å–∫ –¥–ª—è –∫—ç—à–∞
  fastcgi_cache:
    driver_opts:
      type: tmpfs
      device: tmpfs
      # size=256M: –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏
      # mode=1777: –†–∞–∑—Ä–µ—à–∞–µ—Ç —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤—Å–µ–º
      o: "size=256M,mode=1777"
